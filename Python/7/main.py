from dsmltf import defaultdict
import re
import math
import nltk

spam_mess = [
    "Поздравляем! Вы выиграли новый iPhone 15! Заберите свой приз, перейдя по ссылке.",
    "Срочно! Ваш аккаунт взломан. Чтобы восстановить доступ, выполните вход по этой ссылке.",
    "Осталось всего 2 места на наш бесплатный вебинар по быстрому заработку. Зарегистрируйтесь сейчас!",
    "Ваша карта заблокирована. Пройдите по ссылке, чтобы разблокировать и подтвердить свои данные.",
    "Скидка 90% на все товары только сегодня! Поторопитесь, предложение ограничено!",
    "Мы нашли способ, как заработать 1000$ в день без вложений. Узнайте подробнее!",
    "Ваша посылка задержана. Оплатите небольшую пошлину, чтобы получить её быстрее.",
    "Успейте стать партнером нового криптопроекта и получите доход до 500% в месяц.",
    "Ваш аккаунт Google скоро будет удален! Перейдите по ссылке для подтверждения.",
    "Поздравляем! Ваш email выбран для получения крупного денежного приза. Узнайте, как забрать деньги!",
    "Вы стали нашим 1000-м покупателем! Получите скидку 80% на всё. Нажмите здесь, чтобы узнать больше.",
    "Подарок для вас! Получите бонус $500 на ваш счёт после регистрации по ссылке.",
    "Ваш PayPal аккаунт временно заблокирован. Подтвердите личные данные, чтобы восстановить доступ.",
    "Инвестируйте всего $10 и зарабатывайте по $200 каждый день! Начните прямо сейчас.",
    "Секретное видео, как разбогатеть за неделю. Успейте посмотреть, пока доступ не закрыли!",
    "Ищем сотрудников для удалённой работы! Без опыта и вложений. Присоединяйтесь по ссылке.",
    "Ваш номер был выбран для получения подарочного сертификата на $1000! Узнайте, как забрать.",
    "Пройдите бесплатный тест и узнайте, сколько денег вы можете получить от государства!",
    "Вы были выбраны для участия в эксклюзивной акции. Только для ограниченного числа участников!",
    "Скидки на всю продукцию Apple до 90%! Только сегодня! Заходите и выбирайте лучшие модели.",
    "Ваш доступ к эксклюзивной коллекции фильмов активирован! Смотрите бесплатно по ссылке.",
    "Успейте получить бонус $1000 за регистрацию! Присоединяйтесь прямо сейчас!",
    "Остался один шаг до получения вашего приза! Пройдите по ссылке, чтобы завершить регистрацию.",
    "Ваша карта участвует в розыгрыше огромного приза! Проверьте свою удачу сейчас.",
    "Бесплатный подарок к вашей первой покупке! Ссылка на специальное предложение внутри.",
    "Хотите работать из дома и зарабатывать по $500 в день? Узнайте, как начать.",
    "Доступ к эксклюзивному курсу по заработку открыт! Получите знания прямо сейчас.",
    "Только для вас! VIP-доступ к скидкам на лучшие товары. Поторопитесь!",
    "Ваш аккаунт WhatsApp будет удален! Подтвердите его, чтобы избежать потери данных.",
    "Разыскиваются активные пользователи для тестирования продуктов! Оплата за участие гарантирована.",
    "Эксперт по криптовалютам раскроет секреты стабильного дохода! Запишитесь на вебинар.",
    "Только сегодня! Уникальное предложение: скидка 70% на все товары в нашем магазине. Успейте купить!",
    "Ваша карта выбрана для получения бесплатного бонуса. Пройдите по ссылке, чтобы получить свой приз.",
    "Поздравляем! Вы выиграли денежный приз. Чтобы забрать, заполните форму по ссылке.",
    "Ваша подписка на премиум-сервис скоро истекает! Продлите её сейчас и получите бонусы.",
    "Уникальное предложение только для вас! Получите скидку 75% на любимые товары!",
    "Вы наш 10 000-й посетитель! Получите крупный бонус за вход по этой ссылке.",
    "Заработайте 500$ за 2 часа на новой платформе! Узнайте подробности и зарегистрируйтесь.",
    "Ваш профиль выбран для участия в розыгрыше автомобиля! Заполните анкету по ссылке.",
    "Новые вложения с доходностью до 1000%! Узнайте, как начать зарабатывать уже сегодня.",
    "Ваш банковский аккаунт под угрозой! Подтвердите личные данные для защиты.",
    "Обнаружены подозрительные действия на вашем аккаунте. Для защиты выполните вход по ссылке.",
    "Станьте миллионером за месяц! Запишитесь на бесплатный курс и узнайте все секреты.",
    "Ваша заявка на кредит одобрена! Подтвердите информацию по ссылке.",
    "Нажмите здесь и узнайте, как легко заработать, не выходя из дома.",
    "Секретный метод заработка доступен только вам! Проверьте, пока не закрыли доступ.",
    "Ваша посылка готова к отправке. Подтвердите адрес доставки по ссылке.",
    "Срочное сообщение! Вы нарушили правила. Подтвердите личность, чтобы избежать блокировки.",
    "Остался последний шанс получить скидку 50% на лучшие курсы по заработку!",
    "Вы выбраны для участия в тестировании новых продуктов. Оплата гарантирована.",
    "Хотите получать пассивный доход? Подключитесь к нашей платформе уже сегодня!"
]

none_spam_mess = [
    "Здравствуйте! Напоминаем, что ваше собрание запланировано на завтра в 10:00. Просим подтвердить присутствие.",
    "Спасибо за покупку! Ваш заказ отправлен и прибудет в течение 3-5 рабочих дней. Номер отслеживания – в письме.",
    "Приглашаем вас на наш ежегодный семинар! Тема этого года: Эффективное управление временем.",
    "Ваш банковский отчёт за месяц доступен для просмотра в личном кабинете.",
    "Сообщаем, что ваш пароль был успешно изменён. Если вы не выполняли это действие, свяжитесь с поддержкой.",
    "Поздравляем, вы прошли в следующий этап отбора. Пожалуйста, свяжитесь с нами для согласования даты собеседования.",
    "Напоминаем, что абонемент в спортзал заканчивается через 3 дня. Продлите его, чтобы не потерять скидку.",
    "Добрый день! Мы подготовили обновление условий по вашему страховому полису. Ознакомьтесь с ними по ссылке.",
    "Дорогие коллеги! Напоминаем, что на следующей неделе состоится корпоративное мероприятие.",
    "Здравствуйте! Уведомляем, что срок действия вашей кредитной карты истекает в следующем месяце. Пожалуйста, обновите карту.",
    "Уважаемый клиент, ваш отчёт по расходам за прошлый месяц готов и доступен для загрузки в личном кабинете.",
    "Привет! Напоминаем, что на следующей неделе начинается курс, на который вы записались. Подробности в приложении.",
    "Здравствуйте! Ваши анализы готовы. Вы можете получить их в медицинском центре или через онлайн-портал.",
    "Уважаемый пользователь, ваш запрос на изменение настроек безопасности был успешно обработан.",
    "Напоминаем, что срок оплаты коммунальных услуг истекает через 2 дня. Пожалуйста, произведите оплату своевременно.",
    "Здравствуйте, коллеги! На следующей неделе состоится обновление системы. Пожалуйста, заранее сохраните данные.",
    "Ваш пакет доставлен и ожидает вас в пункте выдачи. Пожалуйста, заберите его в течение 7 дней.",
    "Добрый день! Ваша заявка на получение кредита одобрена. Пожалуйста, свяжитесь с нами для уточнения деталей.",
    "Напоминаем, что срок действия вашего проездного билета истекает в этом месяце. Обновите его в личном кабинете.",
    "Уважаемый клиент, ваш страховочный полис будет продлён автоматически. Детали отправлены в приложении к этому письму.",
    "Здравствуйте! Напоминаем, что на следующей неделе запланировано техническое обслуживание. Просим учесть возможные перерывы в работе.",
    "Ваш заказ готов к самовывозу! Вы можете забрать его в удобное для вас время в течение 5 дней.",
    "Уважаемый клиент, вы оставили товар в корзине. Завершите покупку, чтобы не потерять выбранные товары.",
    "Ваш платёж был успешно проведён. Спасибо, что выбрали наш сервис!",
    "Приглашаем вас принять участие в опросе и помочь улучшить качество нашего обслуживания.",
    "Напоминаем, что у вас на следующей неделе назначен визит к врачу. Подробности в приложении.",
    "Здравствуйте! Пожалуйста, обновите информацию о вашем адресе доставки в личном кабинете.",
    "Ваш отчёт по финансам за квартал готов и доступен для просмотра на портале.",
    "Уважаемый клиент, уведомляем, что в условиях вашего договора произошли изменения. Пожалуйста, ознакомьтесь.",
    "На вашем счету накоплены бонусные баллы! Используйте их при следующей покупке.",
    "Добрый день! Мы рады пригласить вас на открытие нашего нового филиала. Ждём вас по адресу, указанному в письме.",
    "Ваш тарифный план был успешно продлён. Спасибо, что остаетесь с нами!",
    "Сообщаем, что в вашем аккаунте были внесены изменения. Если вы не выполняли это действие, обратитесь в поддержку.",
    "Ваш отчёт по успеваемости доступен для просмотра в личном кабинете. Спасибо за участие в учебном процессе!",
    "Напоминаем, что до конца акции осталось 2 дня. Используйте промокод для скидки на следующую покупку.",
    "Уважаемый пользователь, ваш запрос на восстановление доступа был успешно обработан. Добро пожаловать!",
    "Ваш визит к стоматологу запланирован на следующую неделю. Пожалуйста, подтвердите своё посещение.",
    "Спасибо за использование нашего сервиса! Ваш отзыв очень важен для нас.",
    "Добрый день! Напоминаем, что срок сдачи отчётности приближается. Подготовьте необходимые документы.",
    "Поздравляем с успешным завершением курса! Ваш сертификат доступен для скачивания."
]

common_messages = [
    "Поздравляем! Вы выиграли новый iPhone 15! Заберите свой приз, перейдя по ссылке.",
    "Поздравляем! Вы выиграли приз. Пройдите по ссылке, чтобы получить ваш подарок.",
    "Уважаемый клиент, ваш аккаунт был обновлён. Проверьте настройки в личном кабинете.",
    "Чтобы восстановить доступ к вашему аккаунту, подтвердите вашу личность по этой ссылке.",
    "Получите скидку 50% на следующую покупку! Акция действует только до конца недели.",
    "Ваша подписка на сервис успешно продлена. Узнайте больше о новых возможностях.",
    "Мы нашли для вас эксклюзивное предложение! Нажмите на ссылку и получите доступ к скидкам.",
    "Ваша карта приостановлена. Чтобы получить доступ к аккаунту, перейдите по ссылке.",
    "Добрый день! У вас есть новые сообщения от поддержки. Войдите в аккаунт для просмотра.",
    "Узнайте, как получить до 1000 бонусов за каждую покупку. Нажмите здесь для подробностей.",
    "Ваш отчёт за месяц готов. Для доступа к файлу, пожалуйста, войдите в ваш аккаунт.",
    "Вам доступна новая возможность для заработка! Узнайте подробности, перейдя по ссылке.",
    "Срок действия вашей карты истекает. Обновите информацию в аккаунте для продолжения обслуживания.",
    "Ваша заявка на кредит одобрена. Получите доступ к подробной информации в личном кабинете.",
    "Здравствуйте! Мы обнаружили необычную активность на вашем аккаунте. Узнайте, что делать, перейдя по ссылке.",
    "Ваш заказ прибыл на склад. Пройдите по ссылке, чтобы узнать детали доставки."
]

def tokenize(message):
    message = message.lower() # нам не нужны большие буквы
    # извлекаем слова
    all_words = re.findall(r'[а-я0-9]+',message)
    return set(all_words) # возвращаем только уникальные

def word_probabilities(counts, total_spams, total_non_spams, k=0.5):
    return [(w, (spam + k) / (total_spams + 2*k), (non_spam + k) / (total_non_spams + 2*k)) for w, (spam, non_spam) in counts.items()]

def word_probabilities_naiv(counts, total_spams, total_non_spams):
    return [(w, spam / total_spams, non_spam / total_non_spams) for w, (spam, non_spam) in counts.items()]

def count_words(training_set):
    counts = defaultdict(lambda: [0,0])
    for message, is_spam in training_set:
        for word in tokenize(message):
            counts[word][0 if is_spam else 1] +=1
    return counts

def spam_probability(word_probs, message):
    message_words = tokenize(message)
    lp_spam = lp_not_spam = 0.0
    for word, p_spam, p_not_spam in word_probs:
        if word in message_words:
            lp_spam += math.log(p_spam)
            lp_not_spam += math.log(p_not_spam)
        else:
            lp_spam += math.log(1 - p_spam)
            lp_not_spam += math.log(1 - p_not_spam)
    ps = math.exp(lp_spam)
    pns = math.exp(lp_not_spam)
    return ps/(ps+pns)

def spam_probability_naiv(word_probs, message):
    message_words = tokenize(message)
    lp_spam = lp_not_spam = 0.0
    for word, p_spam, p_not_spam in word_probs:
        if word in message_words:
            if (p_spam <= 0 and p_not_spam <= 0):
                lp_spam += math.log(1e-10)
                lp_not_spam += math.log(1e-10)
            elif (p_spam <= 0):
                lp_spam += math.log(1e-10)
                lp_not_spam += math.log(p_not_spam)
            elif (p_not_spam <= 0):
                lp_not_spam += math.log(1e-10)
                lp_spam += math.log(p_spam)
            else:
                lp_spam += math.log(p_spam)
                lp_not_spam += math.log(p_not_spam)
        else:
            lp_spam += math.log(1 - p_spam)
            lp_not_spam += math.log(1 - p_not_spam)
    ps = math.exp(lp_spam)
    pns = math.exp(lp_not_spam)
    return ps/(ps+pns)

def main():
    train_dataset = list(map(lambda sm: (sm, 1), spam_mess)) + list(map(lambda nsm: (nsm, 0), none_spam_mess))
    counts = count_words(train_dataset)
    sorted_data = sorted(counts.items(), key=lambda x: x[1][0], reverse=True)

    indexes = []
    words = [x[0] for x in sorted_data]
    pos = nltk.pos_tag(words, lang='rus')

    for i in range(len(words)):
        if pos[i][1][0] != "A" and len(words[i]) >= 5:
            indexes.append(sorted_data[i])
        if len(indexes) == 7:
            break

    count = dict(indexes)

    k = 0.1
    while (k <= 1):
        print(f"\nПРИ K={k}")
        nb_word_prob = word_probabilities_naiv(count, len(spam_mess), len(none_spam_mess))
        print(nb_word_prob)
        word_prob = word_probabilities(count, len(spam_mess), len(none_spam_mess), k)
        print(word_prob)

        for mes in common_messages:
            print(mes)
            spam_prob1 = spam_probability_naiv(nb_word_prob, mes)
            spam_prob2 = spam_probability(word_prob, mes)
            print(spam_prob1, spam_prob2)
        k += 0.1

if __name__ == '__main__':
    main()
